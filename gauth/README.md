# gauth â€” Cross-Platform Google Auth Token Generator

## Architecture Overview

gauth separates **sign-in** (platform-specific, runs on user's device) from **token generation** (cross-platform Go server). This allows sign-in from any device while centralizing token management.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    REMOTE SERVER (Go)                     â”‚
â”‚  Runs on: VPS, home server, or same machine              â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Device       â”‚  â”‚ Token    â”‚  â”‚ Config/Storage     â”‚  â”‚
â”‚  â”‚ Check-in     â”‚  â”‚ Exchange â”‚  â”‚ (YAML persistence) â”‚  â”‚
â”‚  â”‚ (protobuf)   â”‚  â”‚ (master  â”‚  â”‚                    â”‚  â”‚
â”‚  â”‚              â”‚  â”‚  + svc)  â”‚  â”‚                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚               â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              HTTP API (gauth serve)                  â”‚ â”‚
â”‚  â”‚  POST /api/submit-token  â† receives oauth_token     â”‚ â”‚
â”‚  â”‚  GET  /api/token?scope=  â†’ returns service tokens    â”‚ â”‚
â”‚  â”‚  GET  /api/status        â†’ account info              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ HTTPS
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼              â–¼                  â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Desktop â”‚   â”‚  Mobile  â”‚   â”‚    Browser       â”‚
   â”‚ Client  â”‚   â”‚  Client  â”‚   â”‚    Client        â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## What Runs Where

### Remote Server (Go binary)
Everything except the sign-in WebView. Cross-platform (Win/Linux/Mac/ARM).

| Component | Description |
|-----------|-------------|
| `internal/checkin/` | Protobuf device check-in â†’ `android.clients.google.com` |
| `internal/auth/` | OAuth token exchange â†’ `android.googleapis.com/auth` |
| `internal/config/` | YAML persistence (master token, device profile, email) |
| `internal/server/` | HTTP API for token operations |
| `internal/proto/` | Protobuf encoder/decoder (no codegen) |

### Local Client (per-platform)
Only the sign-in flow. Each client does exactly 4 things:

1. **Open** `accounts.google.com/EmbeddedSetup` in a native WebView
2. **Inject** the `mm` JavaScript bridge (identical JS across all platforms)
3. **Extract** the `oauth_token` cookie after sign-in completes
4. **POST** it to the server's `/api/submit-token` endpoint

---

## Cross-Platform WebView Implementation

### The JavaScript Bridge (shared)
The `mm` JS bridge is **identical** across all platforms â€” ~150 lines of JavaScript that spoofs Android GMS WebView. It defines `window.mm` with 30+ methods (`getAndroidId`, `closeView`, `getAccounts`, etc.) and overrides `navigator.userAgent`/`platform`.

The bridge is generated by the server and fetched by clients via `GET /api/bridge.js`.

### Platform Matrix

| Platform | WebView Runtime | Cookie Access Method | Language | Effort |
|----------|----------------|---------------------|----------|--------|
| **Windows** | WebView2 (Edge) | CDP `Network.getAllCookies` via COM | Go | âœ… Done |
| **Linux** | WebKitGTK | `WebKitCookieManager` API | Go | ~100 LOC |
| **macOS** | WebKit/WKWebView | `WKHTTPCookieStore.getAllCookies()` | Go | ~100 LOC |
| **Android + iOS** | Platform WebView | `CookieManager` / `WKHTTPCookieStore` | Flutter (Dart) | ~80 LOC |
| **Browser** | N/A | `chrome.cookies.getAll()` | JS Extension | ~100 LOC |

### Desktop (Go + webview library)

Currently uses `jchv/go-webview2` (Windows-only). Can switch to `webview/webview` which wraps:
- **Windows** â†’ WebView2
- **Linux** â†’ WebKitGTK
- **macOS** â†’ WebKit

Cookie extraction differs per backend but the Go code structure stays the same.

### Mobile: Flutter (Android + iOS â€” single codebase)

Flutter with `flutter_inappwebview` covers both platforms with one implementation:

```dart
InAppWebView(
  initialUrlRequest: URLRequest(url: WebUri(embeddedSetupUrl)),
  initialUserScripts: [
    UserScript(
      source: mmBridgeJS,  // fetched from GET /api/bridge.js
      injectionTime: UserScriptInjectionTime.AT_DOCUMENT_START,
    )
  ],
  onLoadStop: (controller, url) async {
    // Detects login completion
    if (url.toString().contains('#close') ||
        url.toString().contains('/signin/continue')) {
      // Reads ALL cookies including HttpOnly on BOTH platforms
      final cookies = await CookieManager.instance().getCookies(url: url!);
      final token = cookies.firstWhere((c) => c.name == 'oauth_token').value;

      // Send to server for master token exchange
      await http.post(
        Uri.parse('$serverUrl/api/submit-token'),
        body: jsonEncode({'token': token}),
      );
    }
  },
)
```

> **Why Flutter?** Android's `CookieManager` and iOS's `WKHTTPCookieStore` both natively return HttpOnly cookies. `flutter_inappwebview` wraps both under one API â€” no platform-specific code needed.

---

## Browser Login

### Method 1: Browser Extension (recommended)

A Manifest V3 Chrome/Firefox extension. This is the **only** browser approach that can read HttpOnly cookies.

#### How It Works

```
User clicks "Sign In" in extension popup
        â”‚
        â–¼
Extension opens accounts.google.com/EmbeddedSetup in new tab
        â”‚
        â–¼
content_script.js injects mm JS bridge at document_start
        â”‚
        â–¼
User signs in normally (Google sees Android WebView)
        â”‚
        â–¼
background.js monitors chrome.cookies.onChanged
        â”‚
        â–¼
oauth_token cookie detected â†’ POST to server /api/submit-token
        â”‚
        â–¼
Server exchanges oauth_token â†’ master token, saves config
        â”‚
        â–¼
Extension shows âœ… success, closes login tab
```

#### File Structure

```
extension/
â”œâ”€â”€ manifest.json       # Permissions + content script registration
â”œâ”€â”€ background.js       # Service worker: cookie monitoring + server communication
â”œâ”€â”€ content_script.js   # Injected into Google pages: mm bridge + closeView detection
â”œâ”€â”€ popup.html          # Extension popup UI: Sign In button + status
â”œâ”€â”€ popup.js            # Popup logic: start login flow, show status
â””â”€â”€ icons/
    â”œâ”€â”€ icon16.png
    â”œâ”€â”€ icon48.png
    â””â”€â”€ icon128.png
```

#### manifest.json

```json
{
  "manifest_version": 3,
  "name": "gauth Sign-In",
  "version": "1.0",
  "description": "Sign in to Google for gauth token generation",

  "permissions": [
    "cookies",
    "activeTab",
    "scripting"
  ],

  "host_permissions": [
    "https://accounts.google.com/*"
  ],

  "background": {
    "service_worker": "background.js"
  },

  "content_scripts": [{
    "matches": ["https://accounts.google.com/*"],
    "js": ["content_script.js"],
    "run_at": "document_start",
    "all_frames": true
  }],

  "action": {
    "default_popup": "popup.html",
    "default_icon": {
      "16": "icons/icon16.png",
      "48": "icons/icon48.png",
      "128": "icons/icon128.png"
    }
  }
}
```

**Key permissions:**
- `cookies` â€” read/monitor HttpOnly cookies from `accounts.google.com`
- `host_permissions` â€” access Google's login pages
- `scripting` â€” inject the mm bridge JS dynamically if needed

#### background.js (Service Worker)

```javascript
// Configuration â€” set this to your gauth server
const GAUTH_SERVER = "http://localhost:8080";

// Monitor all cookie changes on accounts.google.com
chrome.cookies.onChanged.addListener(async (changeInfo) => {
  const cookie = changeInfo.cookie;

  // Only care about oauth_token being set (not removed)
  if (cookie.name !== "oauth_token" || changeInfo.removed) return;
  if (!cookie.domain.includes("google.com")) return;

  console.log("[gauth] ğŸ¯ oauth_token captured!", cookie.value.substring(0, 20) + "...");

  try {
    // POST to gauth server
    const resp = await fetch(`${GAUTH_SERVER}/api/submit-token`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token: cookie.value }),
    });
    const data = await resp.json();

    if (data.success) {
      console.log("[gauth] âœ… Master token saved! Email:", data.email);
      // Notify popup
      chrome.storage.local.set({
        loginStatus: "success",
        email: data.email,
      });
      // Close the login tab
      const tabs = await chrome.tabs.query({ url: "https://accounts.google.com/*" });
      for (const tab of tabs) {
        chrome.tabs.remove(tab.id);
      }
    } else {
      console.error("[gauth] âŒ Server error:", data.error);
      chrome.storage.local.set({ loginStatus: "error", error: data.error });
    }
  } catch (err) {
    console.error("[gauth] âŒ Network error:", err);
    chrome.storage.local.set({ loginStatus: "error", error: err.message });
  }
});

// Also support manual extraction via getAllCookies (backup)
chrome.runtime.onMessage.addListener((msg, sender, sendResponse) => {
  if (msg.action === "extractCookies") {
    chrome.cookies.getAll({ domain: "google.com", name: "oauth_token" }, (cookies) => {
      if (cookies.length > 0) {
        sendResponse({ token: cookies[0].value });
      } else {
        sendResponse({ token: null });
      }
    });
    return true; // async sendResponse
  }
});

// Listen for login initiation from popup
chrome.runtime.onMessage.addListener((msg, sender, sendResponse) => {
  if (msg.action === "startLogin") {
    chrome.storage.local.set({ loginStatus: "waiting" });
    chrome.tabs.create({
      url: "https://accounts.google.com/EmbeddedSetup" +
           "?source=android" +
           "&xoauth_display_name=Android+Device" +
           "&lang=en&cc=us&langCountry=en_us&hl=en-US" +
           "&tmpl=new_account"
    });
    sendResponse({ ok: true });
  }
});
```

#### content_script.js

```javascript
// This runs at document_start on all accounts.google.com pages.
// It injects the mm bridge to make Google think we're an Android WebView.

(function() {
  "use strict";

  // Fetch the bridge JS from gauth server (or embed it directly)
  // Option A: Fetch from server
  // fetch("http://localhost:8080/api/bridge.js").then(r => r.text()).then(eval);

  // Option B: Embed directly (preferred â€” no network dependency)
  // The mm bridge object â€” same as native clients
  window.mm = {
    getAndroidId:             function() { return "0"; },
    getBuildVersionSdk:       function() { return 33; },
    getPlayServicesVersionCode: function() { return 224714044; },
    getAuthModuleVersionCode: function() { return 224714044; },
    getAccounts:              function() { return "[]"; },
    getAllowedDomains:        function() { return "[]"; },
    getDeviceDataVersionInfo: function() { return 1; },
    getDeviceContactsCount:   function() { return -1; },
    getFactoryResetChallenges: function() { return "[]"; },
    getPhoneNumber:           function() { return null; },
    getSimSerial:             function() { return null; },
    getSimState:              function() { return 1; },
    hasPhoneNumber:           function() { return false; },
    hasTelephony:             function() { return false; },
    fetchVerifiedPhoneNumber: function() { return null; },
    isUserOwner:              function() { return true; },
    showView:                 function() {},
    closeView:                function() {
      console.log("[gauth-ext] closeView called â€” login complete");
      // Signal background script to extract cookies
      chrome.runtime.sendMessage({ action: "extractCookies" });
    },
    hideKeyboard:             function() {},
    showKeyboard:             function() {},
    setBackButtonEnabled:     function() {},
    setPrimaryActionEnabled:  function() {},
    setPrimaryActionLabel:    function() {},
    setSecondaryActionEnabled: function() {},
    setSecondaryActionLabel:  function() {},
    setAllActionsEnabled:     function() {},
    setAccountIdentifier:     function(name) {
      console.log("[gauth-ext] Account:", name);
    },
    setNewAccountCreated:     function() {},
    addAccount:               function() {},
    attemptLogin:             function() {},
    skipLogin:                function() {},
    goBack:                   function() {},
    log:                      function(s) { console.log("[gauth-ext]", s); },
    backupSyncOptIn:          function() {},
    clearOldLoginAttempts:    function() {},
    notifyOnTermsOfServiceAccepted: function() {},
    fetchIIDToken:            function() {},
    startAfw:                 function() {},
    launchEmergencyDialer:    function() {},
  };

  console.log("[gauth-ext] mm bridge injected");
})();
```

#### popup.html

```html
<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      width: 280px;
      padding: 16px;
      font-family: 'Segoe UI', sans-serif;
      background: #1a1a2e;
      color: #e0e0e0;
      margin: 0;
    }
    h2 { color: #4fc3f7; margin: 0 0 8px; font-size: 16px; }
    .subtitle { color: #888; font-size: 12px; margin-bottom: 16px; }
    button {
      width: 100%;
      padding: 10px;
      background: #4285f4;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }
    button:hover { background: #3367d6; }
    #status {
      margin-top: 12px;
      padding: 8px;
      border-radius: 4px;
      font-size: 12px;
      display: none;
    }
    #status.success { display:block; background: rgba(76,175,80,0.2); color: #4caf50; }
    #status.waiting { display:block; background: rgba(79,195,247,0.2); color: #4fc3f7; }
    #status.error   { display:block; background: rgba(244,67,54,0.2); color: #f44336; }
  </style>
</head>
<body>
  <h2>ğŸ” gauth</h2>
  <p class="subtitle">Sign in to generate auth tokens</p>
  <button id="loginBtn">Sign in with Google</button>
  <div id="status"></div>
  <script src="popup.js"></script>
</body>
</html>
```

#### popup.js

```javascript
const statusEl = document.getElementById("status");
const loginBtn = document.getElementById("loginBtn");

// Start login flow
loginBtn.addEventListener("click", () => {
  chrome.runtime.sendMessage({ action: "startLogin" });
  statusEl.className = "waiting";
  statusEl.textContent = "â³ Waiting for sign-in...";
});

// Poll login status
setInterval(() => {
  chrome.storage.local.get(["loginStatus", "email", "error"], (data) => {
    if (data.loginStatus === "success") {
      statusEl.className = "success";
      statusEl.textContent = "âœ… Signed in as " + data.email;
    } else if (data.loginStatus === "error") {
      statusEl.className = "error";
      statusEl.textContent = "âŒ " + data.error;
    }
  });
}, 1000);
```

#### Browser Compatibility

| Browser | Manifest V3 | HttpOnly Cookies | Content Scripts | Status |
|---------|-------------|-----------------|-----------------|--------|
| **Chrome** | âœ… | âœ… | âœ… | Full support |
| **Edge** | âœ… | âœ… | âœ… | Full support |
| **Brave** | âœ… | âœ… | âœ… | Full support |
| **Firefox** | âœ… (V2 also) | âœ… | âœ… | Full support |
| **Firefox Android** | âœ… | âœ… | âœ… | Mobile browser support |
| **Safari** | âš ï¸ Web Extension API | âš ï¸ Limited | âœ… | Partial |

> **Install without store**: Chrome allows sideloading via `chrome://extensions â†’ Load unpacked`. No store listing needed for personal use.

---

### Method 2: No Extension (limitations)

Without an extension, browsers **cannot** read HttpOnly cookies from `accounts.google.com`:

| Capability | Available? | Why |
|-----------|-----------|-----|
| Inject JS into Google's page | âŒ | Cross-origin, only via extension `content_scripts` |
| Read HttpOnly cookies | âŒ | `document.cookie` excludes HttpOnly by design |
| Intercept Set-Cookie headers | âŒ | No browser JS API for this |
| Read cookies from another domain | âŒ | Same-origin policy |

**The `oauth_token` is HttpOnly** â†’ no browser JavaScript (bookmarklet, userscript, or page script) can read it without extension privileges.

**Alternative: Standard OAuth2 flow (no master token)**
- Use Google's OAuth2 authorization code flow with a redirect to localhost
- Server receives the auth code, exchanges for OAuth2 tokens
- But these are **standard OAuth2 tokens** â€” not master tokens
- Limited to scopes approved in Google Cloud Console, cannot access GMS-level APIs

### Comparison

| Feature | Extension | No Extension |
|---------|-----------|-------------|
| Reads HttpOnly `oauth_token` | âœ… Yes | âŒ Impossible |
| Injects mm bridge | âœ… `content_scripts` | âŒ Cross-origin block |
| Gets master token | âœ… Yes | âŒ OAuth2 only |
| User effort | Install once (sideload) | N/A |
| Browser support | Chrome/Edge/Firefox/Brave | â€” |

> **Verdict**: Browser extension is the **only** browser approach for master token generation. The HttpOnly cookie flag is a hard browser security boundary that cannot be bypassed without extension privileges.

---

## API Endpoints (Server)

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/submit-token` | POST | Client submits `oauth_token` â†’ server exchanges for master token |
| `/api/token` | GET/POST | Fetch service token for a scope (photos, youtube, etc.) |
| `/api/status` | GET | Account registration and login status |
| `/api/apps` | GET | List of known app shortcuts |
| `/api/bridge.js` | GET | Returns the mm JS bridge (for clients to fetch dynamically) |
| `/login` | GET | Web UI for browser-based login |

## File Structure

```
gauth/
â”œâ”€â”€ cmd/gauth/main.go                # CLI entry point
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ proto/                        # Protobuf encoder/decoder
â”‚   â”œâ”€â”€ config/                       # YAML config persistence
â”‚   â”œâ”€â”€ checkin/                      # Device check-in (protobuf)
â”‚   â”œâ”€â”€ auth/                         # Token exchange (master + service)
â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â”œâ”€â”€ bridge.go                 # mm JS bridge generator (shared)
â”‚   â”‚   â”œâ”€â”€ webview.go                # WebView2 login (Windows)
â”‚   â”‚   â””â”€â”€ cookies.go                # CDP cookie extraction (Windows)
â”‚   â””â”€â”€ server/
â”‚       â”œâ”€â”€ server.go                 # HTTP API + web UI
â”‚       â””â”€â”€ proxy.go                  # Reverse proxy (experimental)
â”œâ”€â”€ clients/
â”‚   â”œâ”€â”€ flutter/                      # Flutter WebView (Android + iOS)
â”‚   â””â”€â”€ extension/                    # Browser extension (Chrome/Firefox)
â”‚       â”œâ”€â”€ manifest.json
â”‚       â”œâ”€â”€ background.js
â”‚       â”œâ”€â”€ content_script.js
â”‚       â”œâ”€â”€ popup.html
â”‚       â””â”€â”€ popup.js
â””â”€â”€ go.mod
```
